<!doctype html>
<html lang="en">
  <head>
    <title>Bicycle Color Schemes</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <script src="js/svg-inject.min.js"></script>
    <script src="js/color-pick.js"></script>
    <script src="https://unpkg.com/share-api-polyfill/dist/share-min.js"></script>
  </head>
  <body>
    <div class="flex-grid">
      <div class="col">
      <img id="image" src="img/roadbike.svg" />
      </div>
      <div id="colorPickers" class="col" style="max-width:256px">
      </div>
    </div>
    <button id="sharebtn" title="share" >Share</button>
  </body>
  <script>
    // add color buttons and parse scheme from URL
    document.addEventListener('DOMContentLoaded', function() {
      SVGInject(document.getElementById('image'),{
        onAllFinish: function() {
          // add buttons
          addColorPickers("image", "colorPickers")
          // set current color scheme from query parameters
          params = new URLSearchParams(window.location.search);
          if (params.has("scheme")) {
            setColorScheme(JSON.parse(atob(params.get("scheme"))));
          }
        }
      });

      // add share button
      var target = document.getElementById("sharebtn");
      target.addEventListener('click', () => {
        navigator.share({
          title: 'Bicycle color schema',
          text: "",
          url: window.location.href.split('?')[0] + "?scheme=" + btoa(JSON.stringify(getColorScheme()))
        }).catch(err => {
          console.log("Could not share. Error:", err.message);
        });
      });

      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      };

      // add download button
      dbtn = document.createElement("button");
      dbtn.innerText = "Download";
      //dbtn.onclick = download("rdbk.svg", encodeURIComponent(document.getElementById("image").outerHTML));
      dbtn.onclick = function(){download("rdbk.svg", document.getElementById("image").outerHTML)};
      document.body.appendChild(dbtn);

    });

  </script>
</html>
